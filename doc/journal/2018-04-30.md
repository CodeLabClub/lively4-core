## 2018-04-30 #Plex

playing with Polymorphic identifiers and https://www.plex.tv/ 

```javascript
import {Scheme}  from "src/client/poid.js"
import PolymorphicIdentifier  from "src/client/poid.js"
import focalStorage from "src/external/focalStorage.js"


export class PlexScheme extends Scheme {
  
  get scheme() {
    return "plex"
  }
  
  async plexToken() {
    return focalStorage.getItem("plex-token")
  }

  resolve() {
    return true
  }  

  indexFilename() {
    return ".index.html"
  }
  async GET(options) {
    
    let apiString = this.getAPIString()
    if (apiString.endsWith(this.indexFilename())) {
      let mediacontent = await this.plex(apiString.replace(this.indexFilename(), ""))
      let html = `<html><pre>${mediacontent.outerHTML}</pre></html>`
      return new Response(html, {status: 200})
    }

    let mediacontent = await this.plex(apiString)
    let html = mediacontent.outerHTML
  
    
    return new Response(html, {status: 200})
    
    // return new Response("&st;h1>Nothing found&st;/h1>", {status: 200})
  }

  async plex(apiString) {
    var token = await this.plexToken()
    var text = await fetch("http://127.0.0.1:32400" + apiString + "?X-Plex-Token=" + token).then(r => r.text())
    return new DOMParser().parseFromString(text, "text/xml").childNodes[0];
  }
  
  optionsFromPlex(xml, url) {
    
    return {
      name: xml.getAttribute("key") || xml.getAttribute("title") || xml.getAttribute("title1"),
      title: xml.getAttribute("title") || xml.getAttribute("title1"),
      parent: url.replace(/\/[^/]+\/?$/,""),
      contents: Array.from(xml.childNodes)
        .filter(ea => ea.tagName == "Directory")
        .map(ea => {
          var obj = {
            name: ea.getAttribute("key"),
            title: ea.getAttribute("title") || ea.getAttribute("title1"),
            contents: [],
            parent: url,
            type: ea.tagName == "Directory" ? "directory" : "file"
          }
          if (obj.name.match(/^\//)) {
            obj.type = "link" // symlinks, cross refs... etc
            obj.href = this.scheme + ":/" + obj.name
          }
          return obj
        }).concat([{
          name: ".index.html", // hidden index file
          parent: url,
          contents: [],
          type: "file"
        }]),
      type: "directory"
    }
  }
  
  getAPIString() {
    return this.url.replace(new RegExp("^" + this.scheme+ ":/"),"")
  }
  
  async OPTIONS() {
    var apiString = this.getAPIString().replace(this.indexFilename(),"")
    var mediacontent = await this.plex(apiString)
    var result = await this.optionsFromPlex(mediacontent, this.url)
    return new Response(JSON.stringify(result), {status: 200})
  }
}

PolymorphicIdentifier.register(PlexScheme)

```

