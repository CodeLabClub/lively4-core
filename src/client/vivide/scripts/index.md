# User-defined Vivide Content

<span style="color: red; font-weight: bold;">CAUTION!</span>
Press the button to delete the corresponding file:

<script>
import { scriptFolder, stepFolder, applicationFolder } from 'src/client/vivide/utils.js';
import Script from 'src/client/vivide/vividescript.js';
import View from 'src/client/vivide/components/vivide-view.js';
import { fileName, flatten } from 'utils';

async function createView(content, createEditor = false, createDependents = false, name){
  const componentWindow = await lively.openComponentInWindow('vivide-view');
  if (!createDependents) componentWindow.input = JSON.parse(content.inputs);
  const script = await Script.fromJSON(content.script,componentWindow);
  componentWindow.myCurrentScript = script;
  const widget = document.createElement(content.widget);
  widget.setView(componentWindow);
  await componentWindow.scriptGotUpdated();
  if(createEditor){
    const scriptEditor = await componentWindow.createScriptEditor();
    scriptEditor.setView(componentWindow);
    await scriptEditor.setScript(script);
  }
  if(createDependents){
    componentWindow.applicationName = name;
    const inputs = await Promise.all(content.inputSources.map(i => createView(i, false, true, name)));
    inputs.forEach(i => i.connectTo(componentWindow));
    const outputs = await Promise.all(content.outputs.map(o => createView(o, false, true, name)));
    outputs.forEach(o => componentWindow.connectTo(o));
    if(content.inputs && content.inputs && content.inputs.length !== 0){
      componentWindow.newDataFromUpstream(content.inputs);
    }
  }
  return componentWindow;
}

(async () => {
  let autoGenerated = /(.*-template\.js(on)?$)|(.md?$)/;
  let deleteFunctions = [];
  let folders = [scriptFolder, stepFolder, applicationFolder];
  let fileNames = (await Promise.all(folders.map(async folderURL => {
    let folder = JSON.parse(await lively.files.statFile(folderURL));
    let filenames = folder.contents
      .filter(({ type }) => type === 'file')
      .map(({ name }) => name)
      .filter(name => !autoGenerated.test(name))
      .map(name => folderURL+name);
    return filenames;
  })));
  let buttonList = fileNames.map((folder, i) => <div>
  <h5>{folders[i].split('/')[folders[i].split('/').length-2]}/</h5>
  {...folder.map(urlString => {
    let del = async evt => {
      let delResponse = await fetch(urlString, { method: 'DELETE' });
      if (delResponse.status === 200) {
        lively.success(`deleted file ${urlString::fileName()}`);
        file.remove();
        deleteFunctions = deleteFunctions.filter(df => df !== del);
      } else {
        lively.notify("could not properly delete " + urlString, (await delResponse.text()));
      }
    }
    deleteFunctions.push(del);
    let delbutton = <button click={del}>
      <span style="color: red; font-weight: bold;">Delete</span>
    </button>;
    
    let openbutton = <button click={async () => {
      const filepath = urlString.split('/');
      const content = JSON.parse(await lively.files.loadFile(urlString));
      const name = filepath[filepath.length-1].split('.')[0];
      await createView(content, i === 0, i === 2, name);
    }}>
      <span style="color: blue; font-weight: bold;">Open</span>
    </button>;

    let file = <div>{urlString.split('/')[urlString.split('/').length-1]} {delbutton} {openbutton}</div>;
    return file;
  })}</div>);
  
  let deleteAllScriptsButton = <button click={async evt => {
    await Promise.all(deleteFunctions.map(f => f()));
    lively.success('removed all scripts');
  }}><span style="color: red; font-weight: bold;">DELETE ALL SCRIPTS!</span></button>;

  return <div>
    {deleteAllScriptsButton}
    <div>{...buttonList}</div>
  </div>;
})();
</script>